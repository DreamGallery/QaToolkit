# HoshimiToolkit/lapis

A tool for decrypting assets from Lapis Re:LiGHTs

This project was marked as **archived**, which means there won't be updates or bug fixes anymore.

## Before you decide to go further...

Before you decide to use this tool, you should realize even if you can use my ready-made program, it still could be a tough fight to work through the decryption because there are some tricky customizations must be done during the process. That said, if you don't have any knowledge about programming or reverse-engineering, you'd better close this tab and leave immediately, it's really no need to push yourself to this height.

## How to use

1. Open `LpsPkgMnfstDcpt.sln` with Visual Studio 2022.
2. **Build** project `liblapis`, a `liblapis.dll` generated by VS will appear in `./LpsPkgMnfstDcpt/bin/Debug/` thereafter. If not, it may be somewhere else in project's folder, find and copy it to `./LpsPkgMnfstDcpt/bin/Debug/`.
3. Open `Assembly-CSharp.dll` generated by Il2cppDumper with dnspy, there are some customizations must be done.
    1. Expand Assembly-CSharp.dll -> PE -> Storage Stream -> Tables Stream -> AssemblyRef -> System. Edit **PublicKeyOrToken** flag from 0 to 1.
    2. Locate to `Oz.GameKit.Version.PackageManifest`, edit field `m_PackageInfos` make it **public**.
    3. Locate to `Oz.GameKit.Version.AssetBundleInfo`, there are 2 properties `EncryptKey` and `Name` those we most care about. Edit their **get** accessor in IL to the following codes:
        ```
        ldarg.0
        ldfld  int32 Oz.GameKit.Version.AssetBundleInfo::'<EncryptKey>k__BackingField'
        ret
        ```
        and **set** accessor to:
        ```
        ldarg.0
        ldarg.1
        stfld  int32 Oz.GameKit.Version.AssetBundleInfo::'<EncryptKey>k__BackingField'
        ret
        ```
        In the above examples, `<EncryptKey>` represents it is linked to field `<EncryptKey>k__BackingField`, you should change it to `<Name>` while editing property `Name`'s accessor, meanwhile, change `int32` to `string`.
    4. **Save module** as `Assembly-CSharp.dll`. Be certain you already have a backup before doing such things.
4. Copy `Assembly-CSharp.dll`, `Oz.GameFramework.Runtime.dll`, `Il2CppDummyDll.dll` to `./LpsPkgMnfstDcpt/bin/Debug/`.
5. Add the above 3 dlls to project **LpsPkgMnfstDcpt**'s reference.
6. Move manifest.xml into `./EncryptedFiles/` directory.
7. Move whole assets folder into `./EncryptedFiles/` directory. Be sure **NOT** to change any file or directory name because the path is also a part of name of AssetBundles. Every AssetBundle's name starts with `assets/products/xxx`.  
8. Now you are ready to go. Run LpsPkgMnfstDcpt and output AssetBundles will be generated in `./DecryptedFiles`.
